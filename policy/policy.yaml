APIVersion: 1

# RESTAPISpecs
RESTAPISpecs:

- name: apowine-public-api
  description: Client API Service
  endpoints:
  - URI: "/drink"
    scopes:
    - scope:default
    public: true
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/random"
    scopes:
    - scope:default
    public: true
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/"
    scopes:
    - scope:default
    public: true
    methods: [ GET, POST, PUT, DELETE]
  associatedTags:
  - spec:rest=apowine-public

- name: apowine-internal-api
  description: ApoWine API Service
  endpoints:
  - URI: "/beer"
    scopes:
    - scope:default
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/random"
    scopes:
    - scope:default
    public: true
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/wine"
    scopes:
    - scope:protected
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/wine/*"
    scopes:
    - scope:protected
    methods: [ GET, POST, PUT, DELETE]
  - URI: "/beer/*"
    scopes:
    - scope:default
    methods: [ GET, POST, PUT, DELETE]
  associatedTags:
  - spec:rest=apowine-internal

# Services
services:

- name: apowine-mongodb
  type: TCP
  port: 27017
  exposedPort: 27017
  hosts:
  - "mongodb.apowine.svc.cluster.local"
  selectors:
  - - app=apowine-mongodb
  associatedTags:
    - srv:tcp=mongodb

- name: apowine-server
  type: HTTP
  port: 3000
  exposedPort: 3000
  hosts:
  - "server.apowine.svc.cluster.local"
  selectors:
  - - app=apowine-server
  exposedAPIs:
  - - spec:rest=apowine-internal
  associatedTags:
  - srv:api=apowine-server

- name: apowine-ui
  type: HTTP
  port: 43245
  exposedPort: 4443
  hosts:
  - "apowine.aporeto.com"
  selectors:
  - - app=apowine-ui
  exposedAPIs:
  - - spec:rest=apowine-public
  associatedTags:
  - srv:api=apowine-ui

# TokenScopePolicies
tokenscopepolicies:

- name: apowine-internal-scope
  subject:
  - - app=beer-getter
  - - app=wine-getter
  assignedScopes:
  - scope:default
  - scope:protected

- name: apowine-ui-scope
  subject:
  - - app=apowine-ui
  assignedScopes:
  - scope:default

# NetworkAccessPolicy
networkaccesspolicies:
- name: apowine-access-policy
  subject:
  - - "$identity=processingunit"
  object:
  - - srv:tcp=mongodb
  - - srv:api=apowine-server
  action: "Allow"

- name: allow-any-dns
  subject:
  - - "$identity=processingunit"
  object:
  - - srv:ext=dns
  action: "Allow"

externalServices:
- name: any-dns
  description: "represent any dns"
  type: Network
  network: 0.0.0.0/0
  port: "53"
  protocol: udp
  associatedTags:
  - srv:ext=dns
